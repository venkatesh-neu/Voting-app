trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  ACR_NAME: argocdregistry
  ACR_LOGIN_SERVER: argocdregistry.azurecr.io
  IMAGE_NAME: voting-app

stages:
- stage: BuildAndPush
  jobs:
  - job: DockerBuild
    steps:
    - checkout: self
      persistCredentials: true   # âœ… allows push back to repo

    - task: AzureCLI@2
      inputs:
        azureSubscription: 'argocd_sc'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Logging into ACR..."
          az acr login --name $(ACR_NAME)

          echo "Building Docker image..."
          docker build -t $(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(Build.BuildId) .

          echo "Pushing Docker image..."
          docker push $(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(Build.BuildId)

    - script: |
        chmod +x update_manifest.sh
        ./update_manifest.sh $(ACR_LOGIN_SERVER)/$(IMAGE_NAME) $(Build.BuildId) $(Build.SourceBranchName)
      displayName: "Update Kubernetes manifest"